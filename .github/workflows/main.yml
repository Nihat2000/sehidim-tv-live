name: Catcast Canli Yayim (Loop Fix)

on:
  workflow_dispatch:

jobs:
  stream:
    runs-on: ubuntu-latest
    steps:
      - name: Fayllari Gotur
        uses: actions/checkout@v3

      - name: FFmpeg Qurasdir
        run: sudo apt update && sudo apt install -y ffmpeg curl

      - name: En Son Tokenli Linki Tap və Yayımı Başlat
        run: |
          # Tokenli linki çəkir
          STREAM_URL=$(curl -s https://catcast.tv/sehidimtv | grep -oP 'https://s.catcast.tv/[^"]+index.m3u8\?token=[a-zA-Z0-9]+' | head -n 1)
          echo "Tapılan Link: $STREAM_URL"

          # Düzəliş edilmiş FFmpeg komandası:
          # 1. 'fps=25' əlavə edildi ki, videolar arası kadr fərqi ilişkini kəssin.
          # 2. 'aresample' əlavə edildi ki, səs fərqli olanda yayım dayanmasın.
          # 3. '-map' funksiyası ilə çıxışlar dəqiqləşdirildi.

          ffmpeg -re -stream_loop -1 -f concat -safe 0 -i list.txt \
          -stream_loop -1 -i logo.png \
          -filter_complex "[0:v]scale=1280:720,setsar=1,fps=25[main]; \
                           [1:v]scale=120:-1[l_img]; \
                           [main][l_img]overlay=W-w-30:30[outv]; \
                           [0:a]aresample=44100[outa]" \
          -map "[outv]" -map "[outa]" \
          -vcodec libx264 -preset veryfast -b:v 2500k -maxrate 2500k -bufsize 5000k \
          -pix_fmt yuv420p -fflags +genpts+igndts -c:a aac -b:a 128k -ar 44100 -f flv "rtmp://s.catcast.tv/live/sehidimtv?key=27322_50574_8644e16863c6d6e6"
